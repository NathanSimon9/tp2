[gd_scene load_steps=29 format=3 uid="uid://3uog7aftmdeu"]

[ext_resource type="Texture2D" uid="uid://b6yhw8as2t8w2" path="res://medias/sprites-1.png" id="1_s3281"]
[ext_resource type="Texture2D" uid="uid://d1vweltt53ux8" path="res://medias/sauter.png" id="2_6bys2"]
[ext_resource type="Texture2D" uid="uid://kbgbm7nksnso" path="res://medias/mort.png" id="2_gwbwo"]
[ext_resource type="Texture2D" uid="uid://bieolhmol4lkt" path="res://medias/repos.png" id="2_qfwe2"]
[ext_resource type="Texture2D" uid="uid://dh2k24m61pf6j" path="res://medias/meurt zombie.png" id="3_kyng0"]

[sub_resource type="GDScript" id="GDScript_6bys2"]
script/source = "extends CharacterBody2D

# --- Vitesse ---
const SPEED := 200.0
const BOOST_SPEED := 400.0
const JUMP_VELOCITY := -400.0

# --- États ---
enum Etat { COURIR, MARCHE, REPOS, SAUT, MORT }
var etat_courant := Etat.REPOS

# --- Vie ---
var max_hp := 3
var hp := max_hp
@onready var hearts := $\"../CanvasLayer/HBoxContainer\".get_children()  # récupère tous les cœurs

# --- Position de départ ---
var start_position := Vector2.ZERO

func _ready() -> void:
	$AnimatedSprite2D.modulate = Color(1,1,1,1)
	start_position = global_position
	update_hearts()
	$\"../Area2D\".connect(\"body_entered\", Callable(self, \"_on_area_2d_body_entered\"))

func update_hearts():
	for i in range(len(hearts)):
		if i < hp:
			hearts[i].texture = preload(\"res://medias/coeur.png\")
		else:
			hearts[i].texture = preload(\"res://medias/coeur_vide.png\")

func _physics_process(delta: float) -> void:
	var direction := Input.get_axis(\"marche_arriere\", \"marche\")

	# --- Gestion état MORT ---
	if etat_courant == Etat.MORT:
		velocity += get_gravity() * delta
		move_and_slide()
		return

	# --- Détection des états ---
	if not is_on_floor():
		etat_courant = Etat.SAUT
	elif is_on_floor() and direction == 0:
		etat_courant = Etat.REPOS
	elif is_on_floor() and Input.is_key_pressed(KEY_ALT) and direction != 0:
		etat_courant = Etat.COURIR
	elif is_on_floor() and direction != 0:
		etat_courant = Etat.MARCHE

	# --- Application des états ---
	match etat_courant:
		Etat.SAUT:
			$AnimatedSprite2D.play(\"sauter\")
			velocity += get_gravity() * delta
			if Input.is_action_just_pressed(\"sauter\") and is_on_floor():
				velocity.y = JUMP_VELOCITY
		Etat.REPOS:
			$AnimatedSprite2D.play(\"repos\")
			velocity.x = 0
			if Input.is_action_just_pressed(\"sauter\"):
				velocity.y = JUMP_VELOCITY
		Etat.MARCHE:
			$AnimatedSprite2D.play(\"marcher\")
			velocity.x = direction * SPEED
			if Input.is_action_just_pressed(\"sauter\"):
				velocity.y = JUMP_VELOCITY
		Etat.COURIR:
			$AnimatedSprite2D.play(\"courire\")
			velocity.x = direction * BOOST_SPEED
			if Input.is_action_just_pressed(\"sauter\"):
				velocity.y = JUMP_VELOCITY

	# --- Flip ---
	$AnimatedSprite2D.flip_h = velocity.x < 0

	move_and_slide()

# --- Mort dans le trou ---
func _on_area_2d_body_entered(body: Node2D) -> void:
	if body == self:
		_die_and_reset()

func _die_and_reset() -> void:
	etat_courant = Etat.MORT

	# Knockback horizontal léger seulement
	var knock_dir = sign(global_position.x - start_position.x)
	if knock_dir == 0:
		knock_dir = 1
	velocity.x = 100 * knock_dir
	velocity.y = 0

	$AnimatedSprite2D.play(\"meurt\")
	$AnimatedSprite2D.modulate = Color(1,1,1,0.5)  # semi-transparent

	hp -= 1
	update_hearts()

	await get_tree().create_timer(1.0).timeout

	global_position = start_position
	$AnimatedSprite2D.modulate = Color(1,1,1,1)
	$AnimatedSprite2D.play(\"repos\")
	etat_courant = Etat.REPOS
	velocity = Vector2.ZERO

# --- Mort par ennemi ---
func _die_hit_and_reset(enemy_global_position: Vector2) -> void:
	hp -= 1
	update_hearts()

	etat_courant = Etat.MORT
	var knock_dir = sign(global_position.x - enemy_global_position.x)
	if knock_dir == 0:
		knock_dir = 1
	velocity.x = 300 * knock_dir
	velocity.y = -200

	$AnimatedSprite2D.modulate = Color(1,0.5,0.5,1)  # rouge
	$AnimatedSprite2D.play(\"meurt_frapper\")

	await get_tree().create_timer(1.0).timeout

	if hp <= 0:
		hp = max_hp
		update_hearts()

	global_position = start_position
	$AnimatedSprite2D.modulate = Color(1,1,1,1)
	$AnimatedSprite2D.play(\"repos\")
	etat_courant = Etat.REPOS
	velocity = Vector2.ZERO
"

[sub_resource type="AtlasTexture" id="AtlasTexture_qfwe2"]
atlas = ExtResource("1_s3281")
region = Rect2(5, 394, 225, 394)

[sub_resource type="AtlasTexture" id="AtlasTexture_gwbwo"]
atlas = ExtResource("1_s3281")
region = Rect2(230, 394, 225, 394)

[sub_resource type="AtlasTexture" id="AtlasTexture_kyng0"]
atlas = ExtResource("1_s3281")
region = Rect2(455, 394, 225, 394)

[sub_resource type="AtlasTexture" id="AtlasTexture_7sgir"]
atlas = ExtResource("1_s3281")
region = Rect2(680, 394, 225, 394)

[sub_resource type="AtlasTexture" id="AtlasTexture_wuymh"]
atlas = ExtResource("1_s3281")
region = Rect2(392, 0, 213, 377)

[sub_resource type="AtlasTexture" id="AtlasTexture_tn5gq"]
atlas = ExtResource("1_s3281")
region = Rect2(179, 0, 213, 377)

[sub_resource type="AtlasTexture" id="AtlasTexture_wo6p4"]
atlas = ExtResource("1_s3281")
region = Rect2(605, 0, 213, 377)

[sub_resource type="AtlasTexture" id="AtlasTexture_0hakg"]
atlas = ExtResource("2_gwbwo")
region = Rect2(48, 0, 222, 423)

[sub_resource type="AtlasTexture" id="AtlasTexture_lg1iq"]
atlas = ExtResource("2_gwbwo")
region = Rect2(270, 0, 222, 423)

[sub_resource type="AtlasTexture" id="AtlasTexture_7ewps"]
atlas = ExtResource("2_gwbwo")
region = Rect2(521, 0, 285, 396)

[sub_resource type="AtlasTexture" id="AtlasTexture_l3uw5"]
atlas = ExtResource("2_gwbwo")
region = Rect2(31, 396, 382, 396)

[sub_resource type="AtlasTexture" id="AtlasTexture_cv775"]
atlas = ExtResource("2_gwbwo")
region = Rect2(413, 396, 382, 396)

[sub_resource type="AtlasTexture" id="AtlasTexture_cgkrl"]
atlas = ExtResource("3_kyng0")
region = Rect2(31, 0, 240, 428)

[sub_resource type="AtlasTexture" id="AtlasTexture_ltmng"]
atlas = ExtResource("3_kyng0")
region = Rect2(255, 0, 240, 428)

[sub_resource type="AtlasTexture" id="AtlasTexture_kul21"]
atlas = ExtResource("3_kyng0")
region = Rect2(497, 0, 353, 443)

[sub_resource type="AtlasTexture" id="AtlasTexture_bn7gp"]
atlas = ExtResource("3_kyng0")
region = Rect2(24, 382, 346, 303)

[sub_resource type="AtlasTexture" id="AtlasTexture_onr3x"]
atlas = ExtResource("2_qfwe2")
region = Rect2(109, 0, 201, 382)

[sub_resource type="AtlasTexture" id="AtlasTexture_gos7e"]
atlas = ExtResource("2_qfwe2")
region = Rect2(310, 0, 201, 382)

[sub_resource type="AtlasTexture" id="AtlasTexture_3hj08"]
atlas = ExtResource("2_6bys2")
region = Rect2(90, 0, 226, 427)

[sub_resource type="AtlasTexture" id="AtlasTexture_30wqp"]
atlas = ExtResource("2_6bys2")
region = Rect2(316, 0, 226, 427)

[sub_resource type="SpriteFrames" id="SpriteFrames_kyng0"]
animations = [{
"frames": [{
"duration": 0.6,
"texture": SubResource("AtlasTexture_qfwe2")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_gwbwo")
}, {
"duration": 0.6,
"texture": SubResource("AtlasTexture_kyng0")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_7sgir")
}],
"loop": true,
"name": &"courire",
"speed": 5.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_wuymh")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_tn5gq")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_wo6p4")
}],
"loop": true,
"name": &"marcher",
"speed": 5.0
}, {
"frames": [{
"duration": 0.6,
"texture": SubResource("AtlasTexture_0hakg")
}, {
"duration": 0.9,
"texture": SubResource("AtlasTexture_lg1iq")
}, {
"duration": 0.6,
"texture": SubResource("AtlasTexture_7ewps")
}, {
"duration": 1.1,
"texture": SubResource("AtlasTexture_l3uw5")
}, {
"duration": 1.7,
"texture": SubResource("AtlasTexture_cv775")
}],
"loop": false,
"name": &"meurt",
"speed": 5.0
}, {
"frames": [{
"duration": 0.6,
"texture": SubResource("AtlasTexture_cgkrl")
}, {
"duration": 0.9,
"texture": SubResource("AtlasTexture_ltmng")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_kul21")
}, {
"duration": 4.3,
"texture": SubResource("AtlasTexture_bn7gp")
}],
"loop": true,
"name": &"meurt_frapper",
"speed": 5.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_onr3x")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_gos7e")
}],
"loop": true,
"name": &"repos",
"speed": 5.0
}, {
"frames": [{
"duration": 0.5,
"texture": SubResource("AtlasTexture_3hj08")
}, {
"duration": 7.1,
"texture": SubResource("AtlasTexture_30wqp")
}],
"loop": false,
"name": &"sauter",
"speed": 5.0
}]

[sub_resource type="RectangleShape2D" id="RectangleShape2D_7sgir"]
size = Vector2(44, 107.25)

[node name="personnages" type="CharacterBody2D" groups=["player"]]
collision_layer = 3
collision_mask = 3
script = SubResource("GDScript_6bys2")

[node name="AnimatedSprite2D" type="AnimatedSprite2D" parent="." groups=["player"]]
modulate = Color(1, 0.66, 0.66, 1)
position = Vector2(293, 437)
scale = Vector2(0.404526, 0.404527)
sprite_frames = SubResource("SpriteFrames_kyng0")
animation = &"meurt_frapper"
frame_progress = 0.421633
speed_scale = 1.235

[node name="CollisionShape2D" type="CollisionShape2D" parent="."]
position = Vector2(296, 444)
shape = SubResource("RectangleShape2D_7sgir")

[node name="delai_mort" type="Timer" parent="."]
wait_time = 2.459
one_shot = true

[node name="Camera2D" type="Camera2D" parent="."]
position = Vector2(301, 414)
scale = Vector2(1, 0.999999)
zoom = Vector2(1.155, 1.155)

[node name="BulletShoot" type="Marker2D" parent="."]
position = Vector2(320, 468)
