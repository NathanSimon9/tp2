[gd_scene load_steps=44 format=3 uid="uid://3uog7aftmdeu"]

[ext_resource type="Texture2D" uid="uid://c2raopp0p6tsp" path="res://medias/acroupir.png" id="1_7sgir"]
[ext_resource type="Texture2D" uid="uid://b6yhw8as2t8w2" path="res://medias/sprites-1.png" id="1_s3281"]
[ext_resource type="Texture2D" uid="uid://d1vweltt53ux8" path="res://medias/sauter.png" id="2_6bys2"]
[ext_resource type="Texture2D" uid="uid://kbgbm7nksnso" path="res://medias/mort.png" id="2_gwbwo"]
[ext_resource type="Texture2D" uid="uid://bieolhmol4lkt" path="res://medias/repos.png" id="2_qfwe2"]
[ext_resource type="Texture2D" uid="uid://dh2k24m61pf6j" path="res://medias/meurt zombie.png" id="3_kyng0"]
[ext_resource type="Texture2D" uid="uid://c82ltpa1xaav1" path="res://medias/sprites-10.png" id="7_0hakg"]
[ext_resource type="Script" uid="uid://c0x2u3kphok71" path="res://script/camera_2d.gd" id="7_wuymh"]
[ext_resource type="AudioStream" uid="uid://djrovsrssouto" path="res://sons/cartoon-jump-6462.mp3" id="8_tn5gq"]
[ext_resource type="AudioStream" uid="uid://crj0ia7hponat" path="res://sons/man-death-scream-186763.mp3" id="9_wo6p4"]
[ext_resource type="AudioStream" uid="uid://dwol6635w6c3u" path="res://sons/Firefly_audio_man_drowning_screaming_under_water_variation2 (1).wav" id="10_3hj08"]
[ext_resource type="AudioStream" uid="uid://d1cyr67d0cmbn" path="res://sons/Firefly_audio_grass_footstep_variation4.wav" id="11_30wqp"]
[ext_resource type="AudioStream" uid="uid://cd41qr2iux8ew" path="res://sons/Firefly_audio_big_splash_variation3.wav" id="12_onr3x"]
[ext_resource type="AudioStream" uid="uid://br4xu48a277d8" path="res://sons/Firefly_audio_winning_sound_for_game_variation1.wav" id="13_gos7e"]

[sub_resource type="GDScript" id="GDScript_6bys2"]
script/source = "extends CharacterBody2D

# --- Vitesse ---
const SPEED := 200.0
const BOOST_SPEED := 400.0
const JUMP_VELOCITY := -500.0

# --- États ---
enum Etat { COURIR, MARCHE, REPOS, SAUT, TOMBER, MORT, ACROUPIR }
var etat_courant := Etat.REPOS

# --- Vie ---
var has_died := false
var has_won := false 
var max_hp := 3
var hp := max_hp
@onready var hearts := $\"../CanvasLayer/HBoxContainer\".get_children() if has_node(\"../CanvasLayer/HBoxContainer\") else []

# --- Pièces ---
var coins := 0
@onready var coin_label := $\"../CanvasLayer/CoinCounter/Label\" if has_node(\"../CanvasLayer/CoinCounter/Label\") else null

# --- Position de départ ---
var start_position := Vector2.ZERO

# --- Mouvement autorisé ---
var can_move := true

# --- Direction mémorisée ---
var desired_direction := 0
var is_sprinting := false

func _ready() -> void:
	$AnimatedSprite2D.modulate = Color(1,1,1,1)
	start_position = global_position
	update_hearts()
	update_coins()
	if has_node(\"../CanvasLayer2/VictoryLabel\"):
		$\"../CanvasLayer2/VictoryLabel\".visible = false
	
	# Connecte l'attaque si l'Area2D existe
	if has_node(\"Attackarea\"):
		$Attackarea.body_entered.connect(_on_attack_area_body_entered)

	# --- CONNEXION AU HITBOX DU BOSS ---
	var boss = get_tree().get_root().get_node(\"CheminVersBoss\") # Remplace par le vrai chemin de ton boss
	if boss and boss.has_node(\"HitBoxBody\"):
		boss.HitBoxBody.body_entered.connect(_on_boss_hitbox_body_entered)

# --- Mets à jour les cœurs ---
func update_hearts():
	if hearts.size() == 0:
		return
	for i in range(len(hearts)):
		if i < hp:
			hearts[i].texture = preload(\"res://medias/coeur.png\")
		else:
			hearts[i].texture = preload(\"res://medias/coeur_vide.png\")

# --- Mets à jour les pièces ---
func update_coins():
	if coin_label:
		coin_label.text = str(coins)

# --- Ajoute une pièce ---
func add_coin(amount: int = 1) -> void:
	if has_won:
		return
	coins += amount
	update_coins()
	if coins > 14:
		win_game()

# --- Fonction victoire ---
func win_game():
	if has_won:
		return
	has_won = true
	if has_node(\"../CanvasLayer2/VictoryLabel\"):
		$\"../CanvasLayer2/VictoryLabel\".visible = true
	if has_node(\"../AnimationPlayer\"):
		$\"../AnimationPlayer\".play(\"new_animation\")
		$\"../AnimationPlayer\".animation_finished.connect(_on_animation_finished)

# --- Fonction appelée quand l'animation se termine ---
func _on_animation_finished(anim_name: String) -> void:
	if anim_name == \"new_animation\":
		get_tree().change_scene_to_file(\"res://scenes/niveau_2.tscn\")
	if anim_name == \"RESET\":
		get_tree().change_scene_to_file(\"res://scenes/boss.tscn\")

	# Musique victoire
	if has_node(\"AudioStreamPlayer2D6\"):
		$AudioStreamPlayer2D6.play()
	if has_node(\"../AudioStreamPlayer2D\"):
		$\"../AudioStreamPlayer2D\".stop()
	if has_node(\"../AudioStreamPlayer2D2\"):
		$\"../AudioStreamPlayer2D2\".stop()
	if has_node(\"../AudioStreamPlayer2D3\"):
		$\"../AudioStreamPlayer2D3\".stop()
	if has_node(\"../AudioStreamPlayer2D4\"):
		$\"../AudioStreamPlayer2D4\".stop()

	can_move = false
	velocity.x = 0
	etat_courant = Etat.REPOS
	$AnimatedSprite2D.play(\"repos\")

# --- Fonction défaite ---
func lose_game():
	if has_won:
		return

	if has_node(\"../CanvasLayer2/VictoryLabel\"):
		var victory_label = $\"../CanvasLayer2/VictoryLabel\"
		victory_label.text = \"Vous avez perdu !\"
		victory_label.visible = true

	# Musique de défaite
	if has_node(\"AudioStreamPlayer2D5\"):
		$AudioStreamPlayer2D5.play()
	if has_node(\"../AudioStreamPlayer2D\"):
		$\"../AudioStreamPlayer2D\".stop()
	if has_node(\"../AudioStreamPlayer2D2\"):
		$\"../AudioStreamPlayer2D2\".stop()
	if has_node(\"../AudioStreamPlayer2D3\"):
		$\"../AudioStreamPlayer2D3\".stop()
	if has_node(\"../AudioStreamPlayer2D4\"):
		$\"../AudioStreamPlayer2D4\".stop()

	can_move = false
	velocity.x = 0

	await get_tree().create_timer(5.0).timeout
	get_tree().reload_current_scene()

# --- Physique et états ---
func _physics_process(delta: float) -> void:
	if not can_move:
		velocity += get_gravity() * delta
		move_and_slide()
		return

	var input_direction := Input.get_axis(\"marche_arriere\", \"marche\")
	var pressing_bas := Input.is_key_pressed(KEY_S) or Input.is_key_pressed(KEY_DOWN) or Input.is_action_pressed(\"bas\")
	var sprint_pressed := Input.is_key_pressed(KEY_SHIFT)

	if input_direction != 0:
		desired_direction = input_direction
	elif not Input.is_action_pressed(\"marche\") and not Input.is_action_pressed(\"marche_arriere\"):
		desired_direction = 0

	if sprint_pressed and desired_direction != 0:
		is_sprinting = true
	elif not sprint_pressed:
		is_sprinting = false

	velocity += get_gravity() * delta

	if etat_courant == Etat.MORT:
		move_and_slide()
		return

	if not is_on_floor():
		if velocity.y < 0:
			etat_courant = Etat.SAUT
			$AnimatedSprite2D.play(\"sauter\")
		else:
			etat_courant = Etat.TOMBER
			$AnimatedSprite2D.play(\"tomber\")

		if is_sprinting:
			velocity.x = desired_direction * BOOST_SPEED
		else:
			velocity.x = desired_direction * SPEED

		if pressing_bas:
			velocity.y = 600

		if Input.is_action_just_pressed(\"sauter\") and is_on_floor():
			velocity.y = JUMP_VELOCITY
	else:
		var direction = desired_direction

		if pressing_bas:
			etat_courant = Etat.ACROUPIR
		elif direction == 0:
			etat_courant = Etat.REPOS
		elif sprint_pressed:
			etat_courant = Etat.COURIR
		else:
			etat_courant = Etat.MARCHE

		match etat_courant:
			Etat.REPOS:
				$AnimatedSprite2D.play(\"repos\")
				velocity.x = 0
				if Input.is_action_just_pressed(\"sauter\"):
					if has_node(\"AudioStreamPlayer2D\"):
						$AudioStreamPlayer2D.play()
					velocity.y = JUMP_VELOCITY
			Etat.MARCHE:
				$AnimatedSprite2D.play(\"marcher\")
				velocity.x = direction * SPEED
				if Input.is_action_just_pressed(\"sauter\"):
					if has_node(\"AudioStreamPlayer2D\"):
						$AudioStreamPlayer2D.play()
					velocity.y = JUMP_VELOCITY
			Etat.COURIR:
				$AnimatedSprite2D.play(\"courire\")
				velocity.x = direction * BOOST_SPEED
				if Input.is_action_just_pressed(\"sauter\"):
					if has_node(\"AudioStreamPlayer2D\"):
						$AudioStreamPlayer2D.play()
					velocity.y = JUMP_VELOCITY
			Etat.ACROUPIR:
				$AnimatedSprite2D.play(\"acroupir\")
				if is_on_floor():
					velocity.x = lerp(velocity.x, 0.0, 1.0 * delta)
				else:
					velocity.y = 600

	$AnimatedSprite2D.flip_h = velocity.x < 0
	move_and_slide()

# --- Attaque en sautant sur ennemis ---
func _on_attack_area_body_entered(body: Node2D) -> void:
	if body.has_method(\"take_damage\") and velocity.y > 0:
		body.take_damage(50)
		velocity.y = -400
		if has_node(\"AudioStreamPlayer2D\"):
			$AudioStreamPlayer2D.play()

# --- Mort dans le trou ---
func _on_area_2d_body_entered(body: Node2D) -> void:
	if has_won or has_died:
		return
	if body == self:
		_die_and_reset()

func _die_and_reset() -> void:
	if has_won or has_died:
		return
	has_died = true
	etat_courant = Etat.MORT
	$AnimatedSprite2D.play(\"meurt\")
	await get_tree().create_timer(1.0).timeout
	hp -= 1
	update_hearts()
	if hp <= 0:
		lose_game()
		return
	global_position = start_position
	$AnimatedSprite2D.modulate = Color(1,1,1,1)
	$AnimatedSprite2D.play(\"repos\")
	etat_courant = Etat.REPOS
	velocity = Vector2.ZERO
	has_died = false

# --- Mort par le boss HitBoxBody ---
func _on_boss_hitbox_body_entered(body: Node) -> void:
	if body == self:
		print(\"Touché par le boss !\")
		_die_hit_and_reset(global_position)

# --- Mort par un ennemi ---
func _die_hit_and_reset(enemy_global_position: Vector2) -> void:
	if has_won or has_died:
		return
	has_died = true
	hp -= 1
	update_hearts()
	etat_courant = Etat.MORT
	var knock_dir = sign(global_position.x - enemy_global_position.x)
	if knock_dir == 0:
		knock_dir = 1
	velocity.x = 300 * knock_dir
	velocity.y = -200
	$AnimatedSprite2D.modulate = Color(1,0.5,0.5,1)
	$AnimatedSprite2D.play(\"meurt_frapper\")
	if has_node(\"AudioStreamPlayer2D2\"):
		$AudioStreamPlayer2D2.play()
	await get_tree().create_timer(1.0).timeout

	if hp <= 0:
		lose_game()
		return

	global_position = start_position
	$AnimatedSprite2D.modulate = Color(1,1,1,1)
	$AnimatedSprite2D.play(\"repos\")
	etat_courant = Etat.REPOS
	velocity = Vector2.ZERO
	has_died = false
"

[sub_resource type="AtlasTexture" id="AtlasTexture_3lvrx"]
atlas = ExtResource("1_7sgir")
region = Rect2(95, 0, 220, 493)

[sub_resource type="AtlasTexture" id="AtlasTexture_7eult"]
atlas = ExtResource("1_7sgir")
region = Rect2(339, 0, 221, 507)

[sub_resource type="AtlasTexture" id="AtlasTexture_l6u5r"]
atlas = ExtResource("1_7sgir")
region = Rect2(597, 0, 221, 507)

[sub_resource type="AtlasTexture" id="AtlasTexture_qfwe2"]
atlas = ExtResource("1_s3281")
region = Rect2(5, 394, 225, 394)

[sub_resource type="AtlasTexture" id="AtlasTexture_gwbwo"]
atlas = ExtResource("1_s3281")
region = Rect2(230, 394, 225, 394)

[sub_resource type="AtlasTexture" id="AtlasTexture_kyng0"]
atlas = ExtResource("1_s3281")
region = Rect2(455, 394, 225, 394)

[sub_resource type="AtlasTexture" id="AtlasTexture_7sgir"]
atlas = ExtResource("1_s3281")
region = Rect2(680, 394, 225, 394)

[sub_resource type="AtlasTexture" id="AtlasTexture_wuymh"]
atlas = ExtResource("1_s3281")
region = Rect2(392, 0, 213, 377)

[sub_resource type="AtlasTexture" id="AtlasTexture_tn5gq"]
atlas = ExtResource("1_s3281")
region = Rect2(179, 0, 213, 377)

[sub_resource type="AtlasTexture" id="AtlasTexture_wo6p4"]
atlas = ExtResource("1_s3281")
region = Rect2(605, 0, 213, 377)

[sub_resource type="AtlasTexture" id="AtlasTexture_0hakg"]
atlas = ExtResource("2_gwbwo")
region = Rect2(48, 0, 222, 423)

[sub_resource type="AtlasTexture" id="AtlasTexture_lg1iq"]
atlas = ExtResource("2_gwbwo")
region = Rect2(270, 0, 222, 423)

[sub_resource type="AtlasTexture" id="AtlasTexture_7ewps"]
atlas = ExtResource("2_gwbwo")
region = Rect2(521, 0, 285, 396)

[sub_resource type="AtlasTexture" id="AtlasTexture_l3uw5"]
atlas = ExtResource("2_gwbwo")
region = Rect2(31, 396, 382, 396)

[sub_resource type="AtlasTexture" id="AtlasTexture_cv775"]
atlas = ExtResource("2_gwbwo")
region = Rect2(413, 396, 382, 396)

[sub_resource type="AtlasTexture" id="AtlasTexture_cgkrl"]
atlas = ExtResource("3_kyng0")
region = Rect2(31, 0, 240, 428)

[sub_resource type="AtlasTexture" id="AtlasTexture_ltmng"]
atlas = ExtResource("3_kyng0")
region = Rect2(255, 0, 240, 428)

[sub_resource type="AtlasTexture" id="AtlasTexture_kul21"]
atlas = ExtResource("3_kyng0")
region = Rect2(497, 0, 353, 443)

[sub_resource type="AtlasTexture" id="AtlasTexture_bn7gp"]
atlas = ExtResource("3_kyng0")
region = Rect2(24, 382, 346, 303)

[sub_resource type="AtlasTexture" id="AtlasTexture_onr3x"]
atlas = ExtResource("2_qfwe2")
region = Rect2(109, 0, 201, 382)

[sub_resource type="AtlasTexture" id="AtlasTexture_gos7e"]
atlas = ExtResource("2_qfwe2")
region = Rect2(310, 0, 201, 382)

[sub_resource type="AtlasTexture" id="AtlasTexture_3hj08"]
atlas = ExtResource("2_6bys2")
region = Rect2(90, 0, 226, 427)

[sub_resource type="AtlasTexture" id="AtlasTexture_30wqp"]
atlas = ExtResource("2_6bys2")
region = Rect2(316, 0, 226, 427)

[sub_resource type="AtlasTexture" id="AtlasTexture_2kb80"]
atlas = ExtResource("7_0hakg")
region = Rect2(99, 22, 249, 413)

[sub_resource type="AtlasTexture" id="AtlasTexture_hjndo"]
atlas = ExtResource("7_0hakg")
region = Rect2(594, 19, 246, 413)

[sub_resource type="SpriteFrames" id="SpriteFrames_kyng0"]
animations = [{
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_3lvrx")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_7eult")
}, {
"duration": 100.4,
"texture": SubResource("AtlasTexture_l6u5r")
}, {
"duration": 100.4,
"texture": SubResource("AtlasTexture_l6u5r")
}, {
"duration": 100.4,
"texture": SubResource("AtlasTexture_l6u5r")
}],
"loop": false,
"name": &"acroupir",
"speed": 8.0
}, {
"frames": [{
"duration": 0.6,
"texture": SubResource("AtlasTexture_qfwe2")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_gwbwo")
}, {
"duration": 0.6,
"texture": SubResource("AtlasTexture_kyng0")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_7sgir")
}],
"loop": true,
"name": &"courire",
"speed": 5.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_wuymh")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_tn5gq")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_wo6p4")
}],
"loop": true,
"name": &"marcher",
"speed": 5.0
}, {
"frames": [{
"duration": 0.6,
"texture": SubResource("AtlasTexture_0hakg")
}, {
"duration": 0.9,
"texture": SubResource("AtlasTexture_lg1iq")
}, {
"duration": 0.6,
"texture": SubResource("AtlasTexture_7ewps")
}, {
"duration": 1.1,
"texture": SubResource("AtlasTexture_l3uw5")
}, {
"duration": 12.05,
"texture": SubResource("AtlasTexture_cv775")
}],
"loop": false,
"name": &"meurt",
"speed": 5.0
}, {
"frames": [{
"duration": 0.6,
"texture": SubResource("AtlasTexture_cgkrl")
}, {
"duration": 0.9,
"texture": SubResource("AtlasTexture_ltmng")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_kul21")
}, {
"duration": 107.2,
"texture": SubResource("AtlasTexture_bn7gp")
}],
"loop": true,
"name": &"meurt_frapper",
"speed": 5.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_onr3x")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_gos7e")
}],
"loop": true,
"name": &"repos",
"speed": 5.0
}, {
"frames": [{
"duration": 0.5,
"texture": SubResource("AtlasTexture_3hj08")
}, {
"duration": 5.7,
"texture": SubResource("AtlasTexture_30wqp")
}],
"loop": false,
"name": &"sauter",
"speed": 5.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_2kb80")
}, {
"duration": 1000.0,
"texture": SubResource("AtlasTexture_hjndo")
}],
"loop": false,
"name": &"tomber",
"speed": 5.0
}]

[sub_resource type="RectangleShape2D" id="RectangleShape2D_7sgir"]
size = Vector2(44, 89.625)

[sub_resource type="RectangleShape2D" id="RectangleShape2D_0hakg"]
size = Vector2(44, 12)

[node name="personnages" type="CharacterBody2D" groups=["player"]]
collision_layer = 3
collision_mask = 3
script = SubResource("GDScript_6bys2")

[node name="AnimatedSprite2D" type="AnimatedSprite2D" parent="." groups=["player"]]
modulate = Color(1, 0.66, 0.66, 1)
position = Vector2(293, 437)
scale = Vector2(0.404526, 0.404527)
sprite_frames = SubResource("SpriteFrames_kyng0")
animation = &"tomber"
frame = 1
frame_progress = 1.0
speed_scale = 1.235

[node name="CollisionShape2D" type="CollisionShape2D" parent="."]
position = Vector2(296, 452.813)
shape = SubResource("RectangleShape2D_7sgir")

[node name="delai_mort" type="Timer" parent="."]
wait_time = 2.459
one_shot = true

[node name="Camera2D" type="Camera2D" parent="."]
position = Vector2(301, 414)
scale = Vector2(1, 0.999999)
zoom = Vector2(2, 2)
script = ExtResource("7_wuymh")

[node name="BulletShoot" type="Marker2D" parent="."]
position = Vector2(320, 468)

[node name="AudioStreamPlayer2D" type="AudioStreamPlayer2D" parent="."]
stream = ExtResource("8_tn5gq")
volume_db = 2.811

[node name="AudioStreamPlayer2D2" type="AudioStreamPlayer2D" parent="."]
stream = ExtResource("9_wo6p4")
volume_db = 3.748

[node name="AudioStreamPlayer2D3" type="AudioStreamPlayer2D" parent="."]
stream = ExtResource("10_3hj08")
volume_db = 6.559

[node name="AudioStreamPlayer2D4" type="AudioStreamPlayer2D" parent="."]
stream = ExtResource("11_30wqp")

[node name="AudioStreamPlayer2D5" type="AudioStreamPlayer2D" parent="."]
stream = ExtResource("12_onr3x")
volume_db = 2.811

[node name="AudioStreamPlayer2D6" type="AudioStreamPlayer2D" parent="."]
stream = ExtResource("13_gos7e")

[node name="Attackarea" type="Area2D" parent="."]

[node name="CollisionShape2D" type="CollisionShape2D" parent="Attackarea"]
position = Vector2(296, 494)
shape = SubResource("RectangleShape2D_0hakg")
